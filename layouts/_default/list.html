{{ define "main" }}
    <h1>{{ .Title }}</h1>
    {{- $hasAuthor := isset .Params "author" -}}
    {{- $hasDate := isset .Params "date" -}}
    {{- if or $hasAuthor $hasDate -}}
    <div class="post-meta">
        {{- if $hasAuthor -}}
        <span class="post-byline">By {{if isset .Params "author_url"}}<a href="{{ .Params.author_url }}">{{end}}{{ .Params.author | markdownify }}{{- if isset .Params "author_url" -}}</a>{{- end -}}{{- if isset .Params "author_title" -}}, {{ .Params.author_title | markdownify }}{{- end -}}</span>
        {{- end -}}
        {{- if and $hasAuthor $hasDate -}}<br>{{- end -}}
        {{- if $hasDate -}}
            {{ if eq .Lastmod .Date }}
                <time>Last updated {{ .Date | time.Format "02 January 2006" }}</time>
            {{ else }}
                <time>{{ .Lastmod | time.Format "02 January 2006" }}</time>
            {{ end }}
        {{- end -}}
        </div>
    {{- end -}}
	
	{{- /* Determine if this is a year archive page or main blog page */ -}}
	{{- $isYearArchive := false -}}
	{{- if .File.Dir -}}
		{{- $isYearArchive = ne .File.Dir "blog/" -}}
	{{- end -}}

	{{- if not $isYearArchive -}}
		{{- /* Main blog page: show 10 most recent posts from entire blog section */ -}}
		{{- $recentPosts := first 10 (where .Site.RegularPages "Section" "blog") -}}
		{{- /* Pages are already sorted by date (newest first) by default */ -}}
		{{- if $recentPosts -}}
			<ul id="posts">
				{{ range $recentPosts }} {{ .Render "li" }}{{- end }}
			</ul>
		{{- end -}}
	{{- else -}}
		{{- /* Year archive: show only posts from the year in the URL */ -}}
		{{- $year := .File.Dir | replaceRE "blog/([0-9]+)/" "$1" -}}
		{{- $yearPages := where .Site.RegularPages "Section" "blog" -}}
		{{- $yearPages = where $yearPages "File.Dir" (printf "blog/%s/" $year) -}}
		{{- /* Pages are already sorted by date (newest first) by default */ -}}
		{{- if $yearPages -}}
			<ul id="posts">
				{{ range $yearPages }} {{ .Render "li" }}{{- end }}
			</ul>
		{{- end -}}
	{{- end -}}

	{{- if not $isYearArchive -}}
		{{- /* Show archive links for years with posts (main blog page only) */ -}}
		{{- /* Collect all years that have posts by examining File.Dir */ -}}
		{{- $allYears := slice -}}
		{{- range where .Site.RegularPages "Section" "blog" -}}
			{{- if .File.Dir -}}
				{{- if ne .File.Dir "blog/" -}}
					{{- $year := .File.Dir | replaceRE "blog/([0-9]+)/" "$1" -}}
					{{- if not (in $allYears $year) -}}
						{{- $allYears = $allYears | append $year -}}
					{{- end -}}
				{{- end -}}
			{{- end -}}
		{{- end -}}

		{{- if $allYears -}}
			<h2>Archives</h2>
			<ul>
				{{- /* Sort years in descending order */ -}}
				{{- range sort $allYears "value" "desc" -}}
					{{- $year := . -}}
					{{- $yearPages := where $.Site.RegularPages "Section" "blog" -}}
					{{- $yearPages = where $yearPages "File.Dir" (printf "blog/%s/" $year) -}}
					<li><a href="/blog/{{ $year }}/">{{ $year }} ({{ len $yearPages }} posts)</a></li>
				{{- end -}}
			</ul>
		{{- end -}}
	{{- else -}}
		{{- /* Show links to other years (year archive pages only) */ -}}
		{{- $currentYear := .File.Dir | replaceRE "blog/([0-9]+)/" "$1" -}}
		{{- /* Collect all years that have posts */ -}}
		{{- $otherYears := slice -}}
		{{- range where $.Site.RegularPages "Section" "blog" -}}
			{{- if .File.Dir -}}
				{{- if ne .File.Dir "blog/" -}}
					{{- $year := .File.Dir | replaceRE "blog/([0-9]+)/" "$1" -}}
					{{- if and (ne $year $currentYear) (not (in $otherYears $year)) -}}
						{{- $otherYears = $otherYears | append $year -}}
					{{- end -}}
				{{- end -}}
			{{- end -}}
		{{- end -}}

		{{- if $otherYears -}}
			<h2>Other Years</h2>
			<ul>
				<li><a href="/blog/">Most recent posts</a></li>
				{{- /* Sort years in descending order */ -}}
				{{- range sort $otherYears "value" "desc" -}}
					{{- $year := . -}}
					{{- $yearPages := where $.Site.RegularPages "Section" "blog" -}}
					{{- $yearPages = where $yearPages "File.Dir" (printf "blog/%s/" $year) -}}
					<li><a href="/blog/{{ $year }}/">{{ $year }} ({{ len $yearPages }} posts)</a></li>
				{{- end -}}
			</ul>
		{{- end -}}
	{{- end -}}
{{ end }}
